## Missing Functional Spec – Implementation Plan

Date: 2025-09-27
Owners: Platform, Reviewer, Overseer, Frontend (templates)

### 0. Objective
Close the gaps listed in `Docs/Current/Missing-Functionality.md` by specifying concrete changes across services, APIs, data model, dashboards, observability, and security. Deliver incremental, testable slices.

---

### 1. Reviewer Two‑Tier Orchestration (Light/Heavy)
Status: Implemented (routing, config, metrics); Partial (queue ingestion, admin‑only fingerprint read)
Goal: Route each feed/article through Light Reviewer and, if needed, Heavy Reviewer, using the dedicated microservices instead of in‑process Ollama in `reviewer`.

1.1 Service Changes
- `services/reviewer/main.py`:
  - Replace direct Ollama calls with HTTP calls to `light-reviewer:/review` and `heavy-reviewer:/review`.
  - Keep Redis‑backed config (`reviewer:config`) with keys: `conf_threshold`, `heavy_enabled`, `light_model`, `heavy_model`, `light_workers`.
  - Persist final review on `Article` (unchanged behavior).

1.2 Queue (optional phase 2)
- Introduce Redis LIST `reviewer:queue` for ingestion. Add `/enqueue` endpoint (payload = FeedReviewRequest). Background worker drains queue and routes per two‑tier logic.

1.3 Metrics
- Continue writing latency/error/confidence metrics to Redis.
- Add a Prometheus `/metrics` endpoint (see Section 6) mirroring Redis aggregates.

1.4 Acceptance Criteria
- Given confidence < threshold and heavy enabled → result comes from Heavy Reviewer; otherwise Light.
- Fallback: after 3 heavy retries, store Light result with `fallback=true`.
- Dashboard shows live counts/latency and correct confidence histogram.

---

### 2. Adaptive Cadence: Orchestrator and UI
Status: Implemented (lock + backend status); Missing (dashboard table/UI)
Goal: Enforce non‑overlapping runs per group and surface cadence status (Daily/3‑Day/Weekly) and selection rationale in the dashboard.

2.1 Overseer Backend (`ai-overseer`)
- Add a per‑group generation lock (row lock or Redis SETNX `overseer:group:{id}:lock` with TTL 1h). Abort if locked.
- Expose `GET /cadence/status` returning for each active group: `bucket`, `last_published_at`, `next_eligible_at`, `reason`.

2.2 API Gateway
- Proxy `/api/cadence/status` → overseer.

2.3 Dashboard (admin home)
- Add a small “Cadence” table listing each group, current mode, and next eligible time. Color code when skipped due to insufficient feeds.

2.4 Acceptance Criteria
- Overlapping runs for a group never happen (lock released on completion/error with TTL safeguard).
- Cadence table shows current bucket and next window; changes when an episode publishes.

---

### 3. Writer vs Text‑Generation Alignment
Status: Implemented (Writer as default in overseer); Missing (feature flag wiring)
Goal: Conform to docs where Writer produces the long‑form script (Qwen3). The existing `text-generation` service can remain for alternate paths but default to Writer.

3.1 Overseer Flow
- Update `EpisodeGenerationService.generate_complete_episode` to call Writer script endpoint (`POST /generate-script` in writer) to produce the script.
- Retain `writer /generate-metadata` for metadata.

3.2 Acceptance Criteria
- The generated script comes from Writer service. Metadata still generated by Writer metadata endpoint.
- Feature flag in env `USE_WRITER_FOR_SCRIPT=true` to toggle.

---

### 4. Editor Integration
Status: Implemented (Editor invoked, edited script persisted)
Goal: Pass script through Editor, persist edited script and review.

4.1 Overseer Changes
- After script generation, call `editor:/edit-script` with collection context. Store returned review JSON and replace episode script with edited content.

4.2 Acceptance Criteria
- Edited script replaces raw script in the voiced episode.
- Editor timing and score appear in logs and optional metrics.

---

### 5. Presenter & AudioFile Persistence
Status: Implemented (AudioFile row; mp3 path under storage); Missing (multi‑presenter sequencing)
Goal: Persist `AudioFile` rows and support multi‑presenter sequencing.

5.1 AudioFile DB
- On successful `/generate-audio`, create/update `AudioFile(episode_id, url, duration_seconds, file_size_bytes, format='mp3')`.
- Update `Episode.status` to `VOICED` and keep path under `/app/storage/episodes/{episode_id}/audio.mp3`.

5.2 Multi‑Presenter (phase 2)
- Extend presenter to accept per‑presenter segments or a single blended output. Spec: `presenter_ids` optional; if multiple, segment by script markers (defer full diarization for later).

5.3 Acceptance Criteria
- `AudioFile` row exists post generation; nginx can serve `/storage/episodes/{id}/audio.mp3`.
- If a second generation occurs for same episode, the file is replaced and DB updated.

---

### 6. Publishing Alignment (Local Platforms)
Status: Implemented (publishing to local platforms and status update)
Goal: Use local platforms as per `Local-Hosting.md`.

6.1 Overseer Publishing
- Replace `platforms=["anchor"]` with `platforms=["local_podcast_host","local_rss_feed","local_directory"]` and empty creds.

6.2 Acceptance Criteria
- Publishing returns three records with `status='published'` and working URLs under nginx `http://localhost:8080`.

---

### 7. Observability – Prometheus
Status: Implemented (Prom endpoints across services)
Goal: Provide Prometheus style metrics across services.

7.1 Expose `/metrics` (text/plain)
- Reviewer: `reviewer_light_latency_seconds`, `reviewer_heavy_latency_seconds`, `reviewer_queue_length`, `reviewer_confidence_bucket_total`.
- Overseer: `overseer_episodes_generated_total`, `overseer_generation_duration_seconds`.
- Presenter: `presenter_audio_duration_seconds`, `presenter_failures_total`.
- Publishing: `publishing_success_total`, `publishing_failure_total`.

7.2 Acceptance Criteria
- Metrics endpoints scrape without auth locally; values change under test load.

---

### 8. Security – Admin Auth
Status: Partial (JWT + admin guard for write APIs); Missing (protect dashboard HTML + broader GET APIs)
Goal: Protect dashboard and management APIs with JWT (admin role).

8.1 API Gateway
- Add JWT middleware; protect `/api/*` and HTML templates except `/health`.
- Provide `.env`‑based HMAC secret for dev; pluggable OAuth2 in future.

8.2 Acceptance Criteria
- Anonymous users see a login page; admin tokens allow access.

---

### 9. Dashboard Wiring – Placeholder Cleanup
Status: Partial (most APIs wired; several UI actions still placeholders)
Goal: Replace alerts with working flows and fill missing endpoints.

9.1 Admin Dashboard
- Implement “New Podcast Group” as a modal that POSTs `/api/podcast-groups` (reuse groups modal structure/client code).

9.2 Groups
- Ensure presenters/writers/feeds populate. Add toast feedback on save/delete.

9.3 Episodes
- Implement `generateNewEpisode()`:
  - Modal: select `groupId` from `/api/podcast-groups` then `POST /api/generate-episode` with `{ group_id }`.
- Implement `downloadEpisode(id)`:
  - Add API Gateway `GET /api/episodes/{id}/download` → resolves `AudioFile.url` and redirects to nginx URL.
- Implement `exportEpisodes()` and `viewStats()` later (CSV export; stats modal fed by `/api/stats`).

9.4 News Feed Dashboard
- `refreshAllFeeds()`: fetch `/api/news-feeds`, POST each `/api/news-feed/refresh/{id}`; show summary.
- `addNewFeed()`: modal form → `POST /api/news-feeds`.
- `viewFeedStats()`: modal using `/api/news-feed/stats` with mini chart.
- Performance chart: replace placeholder with chart fed by `/api/news-feed/recent-articles` grouped by hour.

9.5 Collections Dashboard
- `createNewCollection()`: modal (group select) posting to `/api/collections` (gateway proxies to collections service).
- `editCollection(id)`: modal to update status/metadata via `PUT /api/collections/{id}`.

9.6 Presenter Management
- Ensure `/api/presenters` includes `persona`, `voice_model`, `status`; compute or drop `review_count/last_review` until data source is defined.

9.7 Reviewer Dashboard
- Scaling button currently stores `light_workers`; add a backend process (admin API) that applies scaling (dev: compose command, prod: orchestrator job).
- Histogram labels: translate backend histogram keys to buckets `0.00–0.20 … 0.80–1.00` before plotting.

Acceptance Criteria – Dashboards
- All “to be implemented” alerts replaced with functional modals or actions.
- Episode download resolves to an MP3 for voiced/published episodes.

---

### 10. Non‑Functional
Goal: Improve rollout and image hygiene.

10.1 Zero‑Downtime Rollouts
- Compose/Scripts: start new containers, health‑check, then switch traffic (blue/green in compose or via versioned services + nginx upstreams).

10.2 Image Security
- Add CI step: build → scan with Trivy → sign images (cosign). Reject builds with critical CVEs.

Acceptance Criteria
- Rollouts do not drop health checks; images scanned on CI.

---

### 11. API Additions (Sketch)
- API Gateway
  - `GET /api/cadence/status`
  - `GET /api/episodes/{episodeId}/download`
  - `POST /api/reviewer/scale/light` (existing) plus a backend job to enact scaling
- Overseer
  - `GET /cadence/status` (see §2)
- Reviewer (optional)
  - `POST /enqueue` (see §1.2)

---

### 11.1 Immediate Fixes Committed (2025‑09‑27)
- Added `USE_WRITER_FOR_SCRIPT` env toggle in Overseer (defaults to true; falls back to Text‑Generation when false)
- Fixed episode download redirect for local `file://` audio URLs to public `/storage/...` path via gateway
- Mapped reviewer histogram (20×0.05 buckets) to 5×0.20 buckets in Reviewer Dashboard UI
- Added “Cadence Status” table to dashboard, backed by `/api/cadence/status`

---

### 12. Data Model Notes
- Ensure `AudioFile` exists with `episode_id`, `url`, `duration_seconds`, `file_size_bytes`, `format`.
- Consider `Episode.edited_script` vs `Episode.script`; simplest: replace `script` with edited content and store raw in metadata if needed.

---

### 13. Delivery Plan (Phased)
P1: Reviewer orchestration, AudioFile persistence, Publishing local platforms, Episode download.
P2: Writer‑as‑script, Editor step, cadence lock, dashboards wiring (episodes/news‑feed/collections), histogram fix.
P3: Queue ingestion, Prometheus, Admin auth, multi‑presenter, rollout & image security.

---

### 14. Tests & Acceptance
- Unit: reviewer routing logic; overseer publishing selection; audiofile persistence; api‑gateway download.
- Integration: end‑to‑end generation → MP3 → publish to local platforms → accessible via nginx.
- UI: Playwright smoke tests for modals and actions (create group, generate episode, refresh feed).

---

### 15. Risks
- GPU/CPU capacity for reviewer services; introduce back‑pressure via queue length.
- Long‑running script/tts causing locks to overstay; include TTL and finally blocks.


